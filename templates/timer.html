{% extends "layout.html" %}

{% block body %}
    <div class="container">
        <div class="row">
            <div class="col-sm-6 col-sm-offset-3">
                <div class="card">
                    <h1 class="text-center">
                        Focus Timer
                    </h1>
                    <p class="text-center text-muted">Stay focused and productive!</p>

                    <div class="form-group">
                        <label for="time_input">Enter minutes:</label>
                        <input type="number" id="time_input" min="1" value="60" class="form-control">
                    </div>
                    <button id="set_time_button" class="btn btn-primary btn-block" onclick="set_time()">Set Time</button>

                    <h1 id="countdown" class="text-center" style="margin: 20px 0;">60:00</h1>
                    <h2 id="done_alert" class="text-center text-success" style="display: none;">Focus Session Done!</h2>

                    <div class="row">
                        <div class="col-xs-4">
                            <button id="start_button" class="btn btn-success" onclick="timer_update()">Start</button>
                        </div>
                        <div class="col-xs-4">
                            <button id="pause_button" class="btn btn-primary" onclick="pause_timer()">Pause</button>
                        </div>
                        <div class="col-xs-4">
                            <button id="stop_button" class="btn btn-danger" onclick="end_timer()">Reset</button>
                        </div>
                    </div>

                    <h3 class="text-center" style="margin-top: 30px;">Check off tasks during your focus session:</h3>

                    {# filter tasks form #}
                      <form action="{{ url_for('index') }}" method="post" class="filter-entries" id="cat_search_form">
                          <div class="form-group">
                           <label for="category_dropdown">Category search:</label>
                                <select name="category" id="category_dropdown" class="form-select">
                                    <option name="category" value="">All Categories</option>
                                    {% for cat in categories %}
                                        {% if cat.task_category %}
                                            <option name="category" value="{{ cat.task_category }}">{{ cat.task_category }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                          </div>
                          <input type="submit" value="Search" class="btn btn-success btn-block">
                      </form>

                    {# Display task name and task category #}
                    <ul class="list-group">
                        <li class="list-group-item">
                            <div class="row">
                                <div class="col-sm-6">
                                    Task name
                                </div>
                                <div class="col-sm-6">
                                    Task category
                                </div>
                            </div>
                        </li>
                    {# Display tasks along with their categories #}
                        {%for i in task%}
                            <li class="list-group-item">
                                <div class="row">
                                    <div class="col-sm-6">
                                        {{ i.task_name }}
                                    </div>
                                    <div class="col-sm-2">
                                        {{ i.task_category }}
                                    </div>
                                </div>
                                <div class="row">
                                    {# Complete and delete task buttons #}
                                    <div class="col-sm-6">
                                        <form action="{{ url_for('complete_task') }}" method="post" class="delete-entry">
                                            <input hidden name="taskid" value="{{ i.taskid }}">
                                            <input type="submit" value="Complete" class="btn btn-success">
                                        </form>
                                    </div>
                                    <div class="col-sm-6">
                                        <form action="{{ url_for('delete_task') }}" method="post" class="delete-entry">
                                            <input hidden name="taskid" value="{{ i.taskid }}">
                                            <input type="submit" value="Delete" class="btn btn-danger">
                                        </form>
                                    </div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
<script>
    // getting elements to change later
    const display = document.getElementById('countdown');
    const done = document.getElementById('done_alert');
    const startBtn = document.getElementById('start_button');
    const stopBtn = document.getElementById('stop_button');
    const pauseBtn = document.getElementById('pause_button');
    const timeInput = document.getElementById('time_input');
    const setTimeBtn = document.getElementById('set_time_button');

    // setting minutes and seconds to start time
    let seconds = 0;
    let minutes = 60;
    let inputMinutes = 60;
    let interval;

    // sets timer to user inputted time
    function set_time() {
        const userMinutes = parseInt(timeInput.value); // found parseint from here: https://www.w3schools.com/jsref/jsref_parseint.asp

        // checks if input is correct
        if (isNaN(userMinutes) || userMinutes <= 0) {
            alert("Please enter a valid number of minutes.");
            return;
        }

        // sets variables to given time
        inputMinutes = Number(userMinutes);
        minutes = inputMinutes;
        seconds = 0;

        // displays new time
        display.textContent = `${minutes}:00`;
    }

    // this function runs the timer
    function timer_update() {
        // checks if interval exists
        if (interval != null) return;

        // disables start button after timer has been started
        startBtn.disabled = true

        // starts interval loop
        interval = setInterval(() => {
            // checks if timer has ended
            if(seconds === 0 && minutes === 0){
                done.style.display = 'block';

                end_timer();
            }else{
                // updates timer
                if(seconds === 0){
                    seconds = 59;
                    minutes--;
                }else{
                    seconds--;
                }
                display.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`
            }

        }, 1000)
    }

    // this function pauses the timer
    function pause_timer() {
        // checks for an existing interval
        if (interval === null) return;

        // clears existing interval
        clearInterval(interval);
        interval = null;

        // reenables start button
        startBtn.disabled = false;
    }

    // this function ends the timer and resets variables for a clean slate
    function end_timer(){
        // clears interval
        clearInterval(interval);
        interval = null;

        // resets variables
        minutes = inputMinutes;
        seconds = 0;

        // resets display
        display.textContent = `${minutes}:00`;

        // reenables start button
        startBtn.disabled = false
    }
</script>

{% endblock %}